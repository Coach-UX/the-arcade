/* drive.js  @author M.Taniguchi https://masatotaniguchi.jp/ */
var drive=drive||{};drive.ObjectShader={uniforms:{slope:{value:0},offset:{value:0},z:{value:0}},vertexShader:["uniform float	slope;","uniform float	offset;","uniform float	z;","varying vec2	vUv;","varying float	fade;","void main() {","vUv = uv;","vec4	pos = vec4(position, 1.0);","pos.z += z;","pos.y += (pos.z + 700.0) * slope + offset;","fade = min(1.0, (pos.z + 900.0) * 0.005);","gl_Position = projectionMatrix * modelViewMatrix * pos;","}"].join("\n"),fragmentShader:["uniform sampler2D	texture;","varying vec2		vUv;","varying float	fade;","void main() {","vec4	col = texture2D(texture, vUv);","col.a *= fade;","if (col.a <= 0.0) discard;","gl_FragColor = col;","}"].join("\n"),offlineFragmentShader:["uniform sampler2D	texture;","varying vec2		vUv;","varying float	fade;","void main() {","vec4	col = texture2D(texture, vUv);","col.a *= fade;","if ((col.r <= 0.1 && col.g <= 0.1 && col.b <= 0.1) || col.a <= 0.25) discard;","gl_FragColor = col;","}"].join("\n")},drive.ObjectRotShader={uniforms:{slope:{value:0},offset:{value:0},z:{value:0},t:{value:0}},vertexShader:["uniform float	slope;","uniform float	offset;","uniform float	z;","uniform float	t;","varying vec2	vUv;","varying float	fade;","void main() {","vUv = uv;","vec4	pos = vec4(position, 1.0);","float	s = sin(t);","float	c = cos(t);","float	x = pos.x * c - pos.y * s;","float	y = pos.x * s + pos.y * c;","pos.x = x;","pos.y = y;","pos.z += z;","pos.y += (pos.z + 700.0) * slope + offset;","fade = min(1.0, (pos.z + 900.0) * 0.005);","gl_Position = projectionMatrix * modelViewMatrix * pos;","}"].join("\n"),fragmentShader:["uniform sampler2D	texture;","varying vec2		vUv;","varying float		fade;","void main() {","vec4	col = texture2D(texture, vUv);","col.a *= fade;","if (col.a <= 0.0) discard;","gl_FragColor = col;","}"].join("\n")},drive.RoadShader={uniforms:{slope:{value:0},offset:{value:0}},vertexShader:["uniform float	slope;","uniform float	offset;","uniform float	z;","varying vec2	vUv;","varying float	fade;","void main() {","vUv = uv;","vec4	pos = vec4(position, 1.0);","pos.z += z;","float v = pos.z + 700.0;","pos.y += v * slope + offset;","fade = (1.0 - min(1.0, v / 2100.0)) * 0.5;","gl_Position = projectionMatrix * modelViewMatrix * pos;","}"].join("\n"),fragmentShader:["uniform sampler2D	texture;","varying vec2		vUv;","varying float		fade;","void main() {","vec4	col = texture2D(texture, vUv);","col.g += fade;","col.rgb *= 1.5;","gl_FragColor = col;","}"].join("\n")},drive.GroundShader={uniforms:{slope:{value:0},offset:{value:0}},vertexShader:["uniform float	slope;","uniform float	offset;","void main() {","vec4	pos = vec4(position, 1.0);","pos.y += (pos.z + 700.0) * slope + offset;","gl_Position = projectionMatrix * modelViewMatrix * pos;","}"].join("\n"),fragmentShader:["uniform sampler2D	texture;","void main() {","gl_FragColor = vec4(0.21568627451, 0.00784313725, 0.37647058823, 1);","}"].join("\n")},drive.GiftShader={uniforms:{},vertexShader:["varying vec2	vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D	texture;","uniform vec2		uv2;","uniform float		alpha;","varying vec2		vUv;","void main() {","vec4	col = texture2D(texture, vUv + uv2);","col.a *= alpha;","gl_FragColor = col;","}"].join("\n")},drive.ornamentTable=[[0,0,.1,.2,.1,.1,0],[.1,0,.1,.2,.1,.1,395],[.2,0,.1,.2,.1,.1,395],[.3,0,.1,.2,.1,.1,395],[.4,0,.1,.2,.1,.1,395],[.5,0,.1,.2,.1,.1,225],[.6,0,.1,.2,.1,.1,225],[.7,0,.1,.2,.1,.1,225],[.8,0,.1,.2,.1,.1,150],[.9,0,.1,.2,.1,.1,150]],drive.initializedFunction,drive.initialized=0,drive.initCode=0,drive.duration=60,drive.cameraY=0,drive.slope=0,drive.carZ=100,drive.speed=0,drive.tgtSpeed=0,drive.roadWidth=30,drive.enemyWidth=.425*drive.roadWidth,drive.giftWidth=.666*drive.roadWidth,drive.giftPos=new THREE.Vector2(100,100),drive.enemySpeed=0,drive.tgtEnemySpeed=0,drive.enemies=10,drive.gifts=3,drive.tgtX=0,drive.pos=[0,0],drive.car,drive.objDistance=0,drive.interval=300,drive.giftDistance=0,drive.giftInterval=10*drive.interval,drive.enemyIndex=0,drive.giftIndex=-1,drive.crashScale=1e-4,drive.tgtCrashScale=1e-4,drive.PHASE_INIT=0,drive.PHASE_TITLE=1,drive.PHASE_START=2,drive.PHASE_INGAME=3,drive.PHASE_FINISHED=4,drive.PHASE_GAMEOVER=5,drive.PHASE_IDLE=6,drive.phase=drive.PHASE_INIT,drive.time=0,drive.distance=0,drive.score=[0,0],drive.scoreDigits=4,drive.scoreMesh,drive.scoreWidth,drive.hiScore=0,drive.hiScoreMesh,drive.hiScoreWidth,drive.getGiftIndex=0,drive.effectRot=[0,0],drive.effectLength=0,drive.effectX=0,drive.ballPos=new THREE.Vector3(0,0,0),drive.frameVelocity=-8,drive.ornamentIndexTable=[8,6,4,9,7,2,8,6,4,9,7,2,8,6,4,9,7,2,8,6,4,9,7,2,8,6,4,9,7,2,8,6,4,9,7,2],drive.difficulty=1,drive.speedTable=[[200,300,235,2.666],[250,900,325,1.2],[500,1600,450,1]],drive.maxSpeed=[0,0],drive.enemyDuration=0,drive.SetPhase=function(e,i){if(drive.phase!=e||i)switch(drive.phase=e,drive.time=0,drive.phase){case drive.PHASE_INIT:break;case drive.PHASE_TITLE:app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized),app.Fade(0,!0),app.ResetGyro(),drive.rex.visible=!1,drive.frameMat.uniforms.uv2.value=new THREE.Vector2(0,0),drive.frame.visible=!1,drive.car.visible=!1,drive.hiScoreText.visible=!1,drive.textSwipe[0].visible=!1,drive.textSwipe[1].visible=!1,drive.countdown[0].visible=!1,drive.countdown[1].visible=!1,drive.goMat.uniforms.alpha.value=0,drive.score=[0,0],drive.scoreMesh.visible=!1,drive.hiScoreMesh.visible=!1,drive.carMat.uniforms.z.value=drive.carZ,drive.tgtX=0,drive.pos=[0,0],drive.crashScale=drive.tgtCrashScale=.001,drive.crash.position.set(0,-35,drive.carZ+1),drive.crash.scale.set(drive.crashScale,drive.crashScale,1),drive.crashMat.uniforms.alpha.value=1,drive.crash2&&(drive.crash2.position=drive.crash.position,drive.crash2.scale=drive.crash.scale);for(var r=0;r<drive.objMeshs.length;r++)drive.objMeshs[r].visible=!1,drive.objPoss[r]=new THREE.Vector4(-1+r%3,300,0,1+r);drive.enemySpeed=0,drive.tgtEnemySpeed=0,drive.enemyIndex=0,drive.giftIndex=-1,drive.distance=0,drive.getGiftIndex=0,drive.effectRot=[0,0],drive.effectLength=0,drive.effectX=0,drive.ballPos=new THREE.Vector3(0,0,0),drive.frameVelocity=-8,drive.frameMat.uniforms.alpha.value=1,drive.scoreMat.uniforms.alpha.value=1,drive.hiScoreMat.uniforms.alpha.value=1,drive.hudMat.uniforms.alpha.value=1,drive.goMat.uniforms.alpha.value=1;for(var r=0;r<drive.getGiftTable.length;r++)drive.getGiftTable[r]=0;app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized),app.TouchReset(),app.offline||(app.frontCamera.rotation.x=Math.PI*-.0525),app.DotFilter(!1),drive.speed=0,drive.tgtSpeed=0,drive.enemySpeed=drive.tgtEnemySpeed=0,drive.objDistance=drive.giftDistance=drive.distance=0,app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized),buil.Reset(),app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized),fireworks.Reset(),app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized),app.Fade(1),ap.Stop(!0),app.debugShow&&(app.tempEle.innerHTML="drive.title "+ ++drive.initCode+":"+drive.initialized);break;case drive.PHASE_START:app.debugShow&&(app.tempEle.innerHTML="drive.start "+ ++drive.initCode+":"+drive.initialized),app.Fade(0,!0),app.ResetGyro(),app.frontCamera.rotation.x=0,drive.car.visible=!0,drive.scoreMesh.visible=!0,drive.hiScoreMesh.visible=!0,drive.hiScoreText.visible=!0,drive.frame.visible=!0,drive.rex.visible=!0,drive.goMat.uniforms.alpha.value=0,app.offline?(app.mask[0].visible=!0,app.maskMat[0].uniforms.alpha.value=1,drive.countdown[0].scale.set(1,1,1),drive.countdown[1].scale.set(1,1,1),drive.frameMat.uniforms.alpha.value=0):(drive.textSwipe[0].visible=!0,drive.textSwipe[1].visible=!0),buil.Start(),app.ToggleSound(!0),app.Fade(1);break;case drive.PHASE_INGAME:drive.tgtSpeed=drive.speedTable[drive.difficulty][0],drive.maxSpeed[0]=drive.speedTable[drive.difficulty][1],drive.maxSpeed[1]=1450*drive.maxSpeed[0]/1200,drive.enemySpeed=drive.tgtEnemySpeed=75,drive.interval=drive.speedTable[drive.difficulty][2],drive.giftInterval=5*drive.interval,drive.enemyDuration=drive.duration-drive.speedTable[drive.difficulty][3],drive.textSwipe[0].visible=!1,drive.textSwipe[1].visible=!1,drive.countdown[0].visible=!0,drive.countdown[1].visible=!1,drive.goMat.uniforms.alpha.value=1,drive.goAlpha=1,drive.giftEffectTime=0,ap.Play();break;case drive.PHASE_FINISHED:drive.hiScore<drive.score[1]&&Cookies.set("drive.hiScore",drive.score[1],{expires:365}),fireworks.Start(),drive.pos[1]=0,buil.End(!0);break;case drive.PHASE_GAMEOVER:drive.hiScore<drive.score[1]&&Cookies.set("drive.hiScore",drive.score[1],{expires:365}),drive.car.visible=!1,drive.tgtSpeed=0,drive.tgtEnemySpeed=0,app.DotFilter(!0),app.Fade(.45),drive.tgtCrashScale=app.offline?1.55:1,ap.Stop();break;case drive.PHASE_IDLE:ap.Stop()}},drive.Update=function(){var e=app.deltaTime;switch(drive.time+=app.deltaTime,app.offline&&(app.IsKeyTrigger(37)&&drive.Input(void 0,-1),app.IsKeyTrigger(39)&&drive.Input(void 0,1),app.IsKeyTrigger(55)&&(drive.score=[0,0],drive.hiScore=0,drive.hiScoreMat.uniforms.number.value=0,drive.hiScoreMesh.position.x=12.25+app.GetNumberOffsetLeft(0,drive.scoreDigits,drive.hiScoreWidth),Cookies.set("drive.hiScore",0,{expires:365}))),drive.phase){case drive.PHASE_INIT:break;case drive.PHASE_START:drive.time>=4?drive.SetPhase(drive.PHASE_INGAME):drive.time>=3?(drive.countdownMat.uniforms.number.value=1,app.offline&&drive.countdown[1].scale.set(2.1025,2.1025,1)):drive.time>=2?(drive.countdownMat.uniforms.number.value=2,app.offline&&drive.countdown[1].scale.set(1.45,1.45,1)):drive.time>=1&&(drive.countdownMat.uniforms.number.value=3,drive.countdown[1].visible=!0);break;case drive.PHASE_INGAME:if(drive.time<1?app.offline&&(app.maskMat[0].uniforms.alpha.value=1-drive.time,drive.frameMat.uniforms.alpha.value=drive.time):(drive.countdown[0].visible=!1,app.offline&&(app.mask[0].visible=!1,drive.frameMat.uniforms.alpha.value=1)),drive.tgtSpeed=Math.max(drive.tgtSpeed,Math.min(drive.maxSpeed[0],drive.maxSpeed[1]*drive.time/60)),drive.time>=drive.duration)drive.SetPhase(drive.PHASE_FINISHED);else if(drive.time>=drive.duration-.5)buil.End(!0);else if(drive.time<drive.enemyDuration&&drive.distance-drive.objDistance>=drive.interval)if(drive.distance-drive.giftDistance>=drive.giftInterval){var i=drive.enemies+ ++drive.giftIndex%drive.gifts;drive.objPoss[i].w>0&&(drive.objPoss[i].w=0,drive.objPoss[i].x=Math.floor(2.999*Math.random())-1,drive.objPoss[i].y=-900,drive.objMeshs[i].visible=!0,drive.objDistance=drive.distance,drive.giftDistance=drive.distance+10)}else{var i=drive.enemyIndex;drive.objPoss[i].w>0&&(drive.objPoss[i].w=0,drive.objPoss[i].x=Math.floor(2.999*Math.random())-1,drive.objPoss[i].y=-900-100*Math.random(),drive.objMeshs[i].visible=!0,drive.enemyIndex=(drive.enemyIndex+1)%drive.enemies,drive.objDistance=drive.distance)}break;case drive.PHASE_FINISHED:if(drive.carMat.uniforms.z.value-=1100*Math.min(3,drive.time)/2.5*e,drive.time>=1&&drive.time<=2.5){var r=(drive.time-1)/1.5;drive.SunMat.uniforms.alpha.value=Math.sin(r*Math.PI)}if(drive.time>=2.1&&drive.time<=2.8){var r=(drive.time-2.1)/.7+.5;drive.RayMat.uniforms.alpha.value=Math.sin(r*Math.PI),Result(!0,!0,drive.getGiftTable)}if(drive.time>=2.5)return drive.tgtSpeed=0,drive.tgtEnemySpeed=0,app.Fade(.45),void drive.SetPhase(drive.PHASE_IDLE);break;case drive.PHASE_GAMEOVER:if(drive.time>.375){var r=(.625-(drive.time-.375))/.625;drive.tgtCrashScale=Math.max(1e-4,r),drive.crashMat.uniforms.alpha.value=r}if(drive.time>=3)return void drive.SetPhase(drive.PHASE_IDLE);drive.time>=.5&&Result(!0,!1,drive.getGiftTable),drive.crashScale+=16*(drive.tgtCrashScale-drive.crashScale)*e,drive.crash.scale.set(drive.crashScale,drive.crashScale,1),app.offline?(drive.crash.position.x+=16*(app.cameraParallax[2]-drive.crash.position.x)*e,drive.crash.position.y+=16*(-10-drive.crash.position.y)*e,drive.crash2.position.x=drive.crash.position.x,drive.crash2.position.y=drive.crash.position.y,drive.crash2.scale.set(drive.crashScale,drive.crashScale,1)):drive.crash.position.x-=16*drive.crash.position.x*e;var a=Math.max(0,(3-drive.time)/3);drive.frameMat.uniforms.alpha.value=a,drive.scoreMat.uniforms.alpha.value=a,drive.hiScoreMat.uniforms.alpha.value=a,drive.hudMat.uniforms.alpha.value=a;break;case drive.PHASE_IDLE:if(drive.time<=1.5){var a=Math.max(0,(1.5-drive.time)/1.5);drive.frameMat.uniforms.alpha.value>a&&(drive.frameMat.uniforms.alpha.value=a,drive.scoreMat.uniforms.alpha.value=a,drive.hiScoreMat.uniforms.alpha.value=a,drive.hudMat.uniforms.alpha.value=a)}}if(drive.speed+=.5*(drive.tgtSpeed-drive.speed)*e,drive.distance+=drive.speed*e,drive.enemySpeed+=.5*(drive.tgtEnemySpeed-drive.enemySpeed)*e,drive.phase>=drive.PHASE_START&&drive.phase<=drive.PHASE_FINISHED){var r=(drive.pos[1]-drive.pos[0])*(drive.phase==drive.PHASE_FINISHED?1.125:8)*e;drive.pos[0]+=r,drive.carMat.uniforms.t.value=r*-.0125,drive.crash.position.x=drive.pos[0],drive.crash2&&(drive.crash2.position.x=drive.pos[0]),app.offline&&(app.cameraParallax[2]=.25*drive.pos[0])}drive.car.position.set(drive.pos[0],drive.car.position.y,drive.car.position.z);for(var i=0;i<drive.objPoss.length;i++)if(drive.objPoss[i].w<=0){drive.objPoss[i].y+=(drive.speed+drive.enemySpeed)*e;var t=drive.objPoss[i].y;if(300>t){if(drive.objMats[i].uniforms.z.value=t,drive.objMeshs[i].position.set(drive.objPoss[i].x*drive.roadWidth,drive.objMeshs[i].position.y,1e-4*t),drive.phase==drive.PHASE_INGAME){var d=i<drive.enemies;if(Math.abs(t-drive.carZ)<drive.roadWidth){var o=Math.sqrt(Math.pow(drive.car.position.x-drive.objMeshs[i].position.x,2)+Math.pow(drive.carZ-drive.objMats[i].uniforms.z.value,2));o<(d?drive.enemyWidth:drive.giftWidth)&&(d?drive.SetPhase(drive.PHASE_GAMEOVER):(drive.getGiftIndex=drive.giftIndex,drive.getGiftTable[drive.ornamentIndexTable[drive.getGiftIndex]-1]++,drive.effectX=drive.objMeshs[i].position.x,drive.giftEffects[drive.getGiftIndex%drive.gifts].position.set(drive.objMeshs[i].position.x,-35,drive.carZ-.1),drive.effectX>.5*-drive.roadWidth?(drive.effectRot[0]=Math.PI*-.5,drive.effectRot[1]=.25*Math.PI-2*Math.PI):(drive.effectRot[0]=Math.PI*-.5,drive.effectRot[1]=.375*Math.PI),drive.effectLength=0,drive.giftEffectTime=1,drive.ballPos.x=drive.effectX,drive.ballPos.y=-35,drive.ballPos.z=drive.carZ-.1),drive.objMeshs[i].visible=!1,drive.objPoss[i].w=1)}}}else drive.objMeshs[i].visible=!1,drive.objPoss[i].w=1}else drive.objMeshs[i].visible=!1;if(drive.giftEffectTime>0)if(drive.giftEffectTime-=e,drive.giftEffectTime>0){var v=1-drive.giftEffectTime,r=1-.5*(Math.cos(-2*Math.PI*v)+1);drive.effectLength+=4*(1-drive.effectLength)*e,drive.effectRot[0]+=2*(drive.effectRot[1]-drive.effectRot[0])*e;var n=drive.effectLength,l=1-n,s=Math.cos(drive.effectRot[0]),p=Math.sin(drive.effectRot[0]),u=drive.giftEffectMats[drive.getGiftIndex%drive.gifts].uniforms;if(u.offset.value.x=2*n*s,u.offset.value.y=2*n*p,u.offset.value.z=3*n,u.alpha.value=r,drive.ballPos.x=app.EaseInOut(drive.effectX,drive.giftPos.x,1.4*v),drive.effectRot[1]<0?(drive.ballPos.y=app.EaseInOut(-35,drive.giftPos.y+8,1.25*v),drive.ballPos.z=app.EaseInOut(drive.carZ,0,1.25*v),drive.ball.position.set(drive.ballPos.x-350*r*l,drive.ballPos.y,drive.ballPos.z)):(drive.ballPos.y=app.EaseIn(-35,drive.giftPos.y+8,1.3*v),drive.ballPos.z=app.EaseIn(drive.carZ,0,1.25*v),drive.ball.position.set(drive.ballPos.x- -50*r*l,drive.ballPos.y,drive.ballPos.z)),u=drive.ballMat.uniforms,u.offset.value.x=2*r*s,u.offset.value.y=2*r*p,u.offset.value.z=2*r,u.alpha.value=r,drive.giftEffectTime<.31&&drive.frameVelocity<=-8){drive.frameVelocity=4,drive.halo.position.z=.1,drive.haloMat.uniforms.alpha.value=1;var f=drive.ornamentTable[drive.ornamentIndexTable[drive.getGiftIndex]];drive.frameMat.uniforms.uv2.value=new THREE.Vector2(f[0],f[1]),drive.score[1]+=f[6]}}else drive.giftEffects[drive.getGiftIndex%drive.gifts].position.z=300,drive.giftEffectMats[drive.getGiftIndex%drive.gifts].uniforms.alpha.value=0,drive.ball.position.z=300,drive.ballMat.uniforms.alpha.value=0,drive.halo.position.z=1e3,drive.hiScore<drive.score[1]&&Cookies.set("drive.hiScore",drive.score[1],{expires:365});drive.frameVelocity>-8&&(drive.frame.position.y=drive.halo.position.y=Math.max(drive.giftPos.y,drive.frame.position.y+drive.frameVelocity),drive.frameVelocity-=30*e,drive.haloMat.uniforms.alpha.value-=3.5*e),drive.score[0]=Math.min(drive.score[1],drive.score[0]+=3*(drive.score[1]+100-drive.score[0])*e);var c=Math.round(drive.score[0]);drive.scoreMat.uniforms.number.value=c,drive.scoreMesh.position.x=.25+app.GetNumberOffset(c,drive.scoreWidth),drive.hiScore<c&&(drive.hiScore=c,drive.hiScoreMat.uniforms.number.value=c,drive.hiScoreMesh.position.x=12.25+app.GetNumberOffsetLeft(c,drive.scoreDigits,drive.hiScoreWidth)),app.offline&&(drive.goMat.uniforms.alpha.value>0?(drive.countdown[0].visible=!0,drive.countdown[0].scale.x+=8*e,drive.countdown[0].scale.y+=8*e,drive.goAlpha=Math.max(0,drive.goAlpha-e),drive.goMat.uniforms.alpha.value=1-Math.pow(1-drive.goAlpha,2.5)):(drive.goMat.uniforms.alpha.value=0,drive.goAlpha=1,drive.countdown[0].scale.set(1,1,1))),ap.Update(app.time,e)},drive.Draw=function(){drive.phase>=drive.PHASE_START&&buil.Draw(),drive.phase>=drive.PHASE_FINISHED&&fireworks.Draw()},drive.Input=function(e,i){if(drive.phase>=drive.PHASE_START&&drive.phase<=drive.PHASE_INGAME)if(i)drive.tgtX=Math.min(1,Math.max(-1,drive.tgtX+i)),drive.pos[1]=drive.tgtX*drive.roadWidth;else if(e){var r=.5*app.clientWidth;e=1.1*(e-r)+r,drive.tgtX=Math.min(1,Math.max(-1,Math.floor(3*e/app.clientWidth)-1)),drive.pos[1]=drive.tgtX*drive.roadWidth}},drive.Initialize=function(e){app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized),drive.cameraY=(app.offline,60),drive.slope=app.offline?-.125:-.125,drive.carZ=app.offline?112.5:125,drive.giftPos.x=app.offline?147:71,drive.giftPos.y=app.offline?69:117,app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized);var i,r,a=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:1}},depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader});app.offline?(i=550,r=app.CreateMesh(1400,i,0,a,app.table.DriveBG),r.position.set(0,drive.cameraY+.6*i,-1e3)):(i=675,r=app.CreateMesh(990,i,0,a,app.table.DriveBG),r.position.set(0,drive.cameraY+.575*i,-1e3)),app.backScene.add(r),a=new THREE.ShaderMaterial({uniforms:{texture:{value:app.symbolTexture},alpha:{value:.75}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),app.offline?(i=580,drive.rex=app.CreateMesh(i*app.symbolTable.DriveSymbolRex[4],i*app.symbolTable.DriveSymbolRex[5],0,a,app.symbolTable.DriveSymbolRex),drive.rex.position.set(0,drive.cameraY+i*app.symbolTable.DriveSymbolRex[5]*.925,-950)):(i=666*app.symbolTable.DriveSymbolRex[5],drive.rex=app.CreateMesh(666*app.symbolTable.DriveSymbolRex[4],i,0,a,app.symbolTable.DriveSymbolRex),drive.rex.position.set(0,drive.cameraY+.975*i,-950)),drive.rex.visible=!1,app.backScene.add(drive.rex),a=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:1}},blending:THREE.NormalBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader});var t;app.offline?(i=7750*app.table.Mountain[5],t=app.CreateMesh(7750*app.table.Mountain[4],i,0,a,app.table.Mountain),t.position.set(0,drive.cameraY+.4*i,-910)):(i=5610*app.table.Mountain[5],t=app.CreateMesh(5610*app.table.Mountain[4],i,0,a,app.table.Mountain),t.position.set(0,drive.cameraY+.5125*i,-910)),app.backScene.add(t),drive.SunMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),app.table.CircleBlur[3]*=.5,app.table.CircleBlur[1]+=app.table.CircleBlur[3],app.table.CircleBlur[5]*=.25;var d=app.CreateMesh(6e3*app.table.CircleBlur[4],6e3*app.table.CircleBlur[5],0,drive.SunMat,app.table.CircleBlur);d.position.set(0,app.offline?103:100,-905),app.backScene.add(d),drive.RayMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),app.table.CircleBlur[0]+=.5*app.table.CircleBlur[2],app.table.CircleBlur[2]=0;var d=app.CreateMesh(2e3,6e3*app.table.CircleBlur[5],0,drive.RayMat,app.table.CircleBlur);d.position.set(0,app.offline?75:77,-905),app.backScene.add(d),drive.crashMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:1}},blending:THREE.NormalBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),drive.crash=app.CreateMesh(820*app.table.Crash[4],820*app.table.Crash[5],0,drive.crashMat,app.table.Crash),drive.crash.position.set(0,-35,drive.carZ+1),drive.crash.scale.set(drive.crashScale,drive.crashScale,1),app.frontScene.add(drive.crash),app.offline&&(drive.crash2=drive.crash.clone(),app.backScene.add(drive.crash2)),drive.giftEffectMats=new Array,drive.giftEffects=new Array;for(var o=["GiftBox1","GiftBox2","GiftBox3"],v=0;v<drive.gifts;v++){drive.giftEffectMats[v]=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},offset:{value:new THREE.Vector3(0,0,0)},alpha:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.BlurShader.vertexShader,fragmentShader:app.BlurShader.fragmentShader});var n=o[v];drive.giftEffects[v]=app.CreateBlurMesh(270*app.table[n][4],270*app.table[n][5],0,drive.giftEffectMats[v],app.table[n],16),drive.giftEffects[v].position.set(0,-35,300),app.frontScene.add(drive.giftEffects[v])}drive.ballMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},offset:{value:new THREE.Vector3(0,0,0)},alpha:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.BlurShader.vertexShader,fragmentShader:app.BlurShader.fragmentShader}),drive.ball=app.CreateBlurMesh(175*app.table.Circle[4],175*app.table.Circle[5],0,drive.ballMat,app.table.Circle,12),drive.ball.position.set(0,-35,300),app.uiScene.add(drive.ball),drive.haloMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},alpha:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),drive.halo=app.CreateMesh(5500*app.table.SunHalo[4],5500*app.table.SunHalo[5],0,drive.haloMat,app.table.SunHalo),drive.halo.position.set(drive.giftPos.x,drive.giftPos.y,1e3),app.uiScene.add(drive.halo),app.textureLoader.load("./img/ornament.png",function(e){e.format=THREE.RGBAFormat,e.generateMipmaps=!0,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter,drive.frameMat=new THREE.ShaderMaterial({uniforms:{texture:{value:e},uv2:{value:new THREE.Vector2(0,0)},alpha:{value:1}},blending:THREE.NormalBlending,transparent:!0,depthWrite:!1,vertexShader:drive.GiftShader.vertexShader,fragmentShader:drive.GiftShader.fragmentShader}),drive.frame=app.CreateMesh(380*drive.ornamentTable[0][4],380*drive.ornamentTable[0][5],0,drive.frameMat,drive.ornamentTable[0]),drive.frame.position.set(drive.giftPos.x,drive.giftPos.y,0),drive.frame.visible=!1,app.uiScene.add(drive.frame),app.offline&&(drive.frame.scale.set(1.85,1.85,1),drive.halo.scale.set(1.85,1.85,1)),drive.initialized++,app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized)}),a=new THREE.ShaderMaterial({uniforms:{slope:{value:drive.slope},offset:{value:drive.cameraY}},vertexShader:drive.GroundShader.vertexShader,fragmentShader:drive.GroundShader.fragmentShader});var l=app.CreateMesh(2e3,0,1800,a);l.position.set(0,-.25,0),app.backScene.add(l),app.textureLoader.load("./img/Road.png",function(e){e.format=THREE.RGBAFormat,e.generateMipmaps=!0,e.wrapS=THREE.ClampToEdgeWrapping,e.wrapT=THREE.ClampToEdgeWrapping,a=new THREE.ShaderMaterial({uniforms:{texture:{value:e},slope:{value:drive.slope},offset:{value:drive.cameraY},z:{value:0}},blending:THREE.AdditiveBlending,transparent:!0,vertexShader:drive.RoadShader.vertexShader,fragmentShader:drive.RoadShader.fragmentShader});var i=app.CreateMesh(160,0,1800,a);app.backScene.add(i),drive.initialized++,app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized)}),drive.carMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},slope:{value:drive.slope},offset:{value:drive.cameraY},z:{value:drive.carZ},t:{value:0}},blending:THREE.NormalBlending,transparent:!0,vertexShader:drive.ObjectRotShader.vertexShader,fragmentShader:drive.ObjectRotShader.fragmentShader}),drive.car=app.CreateMesh(310*app.table.Car[4],310*app.table.Car[5],0,drive.carMat,app.table.Car),drive.car.position.set(0,77.5*app.table.Car[5],1e-4*drive.carZ),drive.car.visible=!1,app.frontScene.add(drive.car),drive.objMats=new Array,drive.objMeshs=new Array,drive.objPoss=new Array;for(var s=["Black-cars00001","Black-cars00002","Black-cars00003","Black-cars00004","Black-cars00005","Black-cars00001","Black-cars00002","Black-cars00003","Black-cars00004","Black-cars00005","GiftBox1","GiftBox2","GiftBox3"],v=0;v<s.length;v++){var p=app.table[s[v]];drive.objMats[v]=new THREE.ShaderMaterial({uniforms:{texture:{value:app.texture},slope:{value:drive.slope},offset:{value:drive.cameraY},z:{value:300}},blending:THREE.NormalBlending,transparent:!0,vertexShader:drive.ObjectShader.vertexShader,fragmentShader:app.offline?drive.ObjectShader.offlineFragmentShader:drive.ObjectShader.fragmentShader}),v<drive.enemies?(drive.objMeshs[v]=app.CreateMesh(400*p[4],400*p[5],0,drive.objMats[v],p),drive.objMeshs[v].position.set(-30+10*v,150*p[5],300)):(drive.objMeshs[v]=app.CreateMesh(270*p[4],270*p[5],0,drive.objMats[v],p),drive.objMeshs[v].position.set(-30+10*v,110*p[5],300)),drive.objMeshs[v].visible=!1,app.frontScene.add(drive.objMeshs[v]),drive.objPoss[v]=new THREE.Vector4(-1+v%3,300,0,1+v)}drive.hudMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.fontTexture},alpha:{value:1}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),app.offline?(drive.hiScoreText=app.CreateFontMesh("HIGH SCORE:",9.5,drive.hudMat,!0),drive.hiScoreText.position.set(-77.25,drive.giftPos.y+10.75,0)):(drive.hiScoreText=app.CreateFontMesh("HIGH SCORE:",8.5,drive.hudMat,!0),drive.hiScoreText.position.set(-68,drive.giftPos.y+10.75,0)),drive.hiScoreText.visible=!1,app.uiScene.add(drive.hiScoreText),drive.textSwipe=new Array,drive.textSwipe[0]=app.CreateFontMesh("<             >",18,drive.hudMat),drive.textSwipe[0].position.set(0,-110,0),drive.textSwipe[0].visible=!1,app.uiScene.add(drive.textSwipe[0]),drive.textSwipe[1]=app.CreateFontMesh("SWIPE TO MOVE",8.5,drive.hudMat),drive.textSwipe[1].position.set(0,-110,0),drive.textSwipe[1].visible=!1,app.uiScene.add(drive.textSwipe[1]),drive.goMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.fontTexture},alpha:{value:1}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.PlaneShader.vertexShader,fragmentShader:app.PlaneShader.fragmentShader}),drive.countdown=new Array,drive.countdown[0]=app.CreateFontMesh("GO",53,drive.goMat),drive.countdown[0].position.set(0,0,0),drive.countdown[0].visible=!1,app.uiScene.add(drive.countdown[0]),drive.countdownMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.numberTexture},number:{value:3},alpha:{value:1}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.NumberShader.vertexShader,fragmentShader:app.NumberShader.fragmentShader}),drive.countdown[1]=app.CreateNumberMesh(1,53,drive.countdownMat)[0],drive.countdown[1].position.set(0,0,0),drive.countdown[1].visible=!1,app.offline?app.uiBackScene.add(drive.countdown[1]):app.uiScene.add(drive.countdown[1]),drive.scoreMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.numberTexture},number:{value:drive.score[0]},alpha:{value:1}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.NumberShader.vertexShader,fragmentShader:app.NumberShader.fragmentShader}),app.offline?temp=app.CreateNumberMesh(drive.scoreDigits,13.5,drive.scoreMat,!1):temp=app.CreateNumberMesh(drive.scoreDigits,12.5,drive.scoreMat,!1),drive.scoreMesh=temp[0],drive.scoreWidth=temp[1],drive.scoreMesh.position.set(app.GetNumberOffset(drive.score[0],drive.scoreWidth,!1),drive.giftPos.y-4.25,0),drive.scoreMesh.visible=!1,app.uiScene.add(drive.scoreMesh),drive.hiScore=parseInt(Cookies.get("drive.hiScore"))||0,drive.hiScoreMat=new THREE.ShaderMaterial({uniforms:{texture:{value:app.numberTexture},number:{value:drive.hiScore},alpha:{value:1}},blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:app.NumberShader.vertexShader,fragmentShader:app.NumberShader.fragmentShader}),app.offline?temp=app.CreateNumberMesh(drive.scoreDigits,9,drive.hiScoreMat,!0):temp=app.CreateNumberMesh(drive.scoreDigits,8.5,drive.hiScoreMat,!0),drive.hiScoreMesh=temp[0],drive.hiScoreWidth=temp[1],drive.hiScoreMesh.position.set(12.25+app.GetNumberOffsetLeft(drive.hiScore,drive.scoreDigits,drive.hiScoreWidth),drive.giftPos.y+10.75,0),drive.hiScoreMesh.visible=!1,app.uiScene.add(drive.hiScoreMesh),drive.getGiftTable=new Array(drive.ornamentTable.length),app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized),buil.Initialize(),fireworks.Initialize(),app.uiFix=!0,app.gameUpdateFunction=drive.Update,app.gameDrawFunction=drive.Draw,app.gameInputFunction=drive.Input,void 0!=e&&(drive.initializedFunction=e,setTimeout(function(){drive.WaitInitialized()},50)),app.debugShow&&(app.tempEle.innerHTML="drive.init "+ ++drive.initCode+":"+drive.initialized)},drive.IsInitialized=function(){return drive.initialized>=2},drive.WaitInitialized=function(){drive.IsInitialized()?(drive.Reset(),void 0!=drive.initializedFunction&&drive.initializedFunction()):(app.debugShow&&(app.tempEle.innerHTML="drive.initWait "+drive.initCode+":"+drive.initialized),setTimeout(function(){drive.WaitInitialized()},100))},drive.Start=function(e){drive.difficulty=void 0!=e?e:1,drive.SetPhase(drive.PHASE_START),app.debugShow&&(app.tempEle.innerHTML="drive.start")},drive.Reset=function(){drive.SetPhase(drive.PHASE_TITLE,!0)},drive.Name=function(){return"drive"};var buil=buil||{};buil.Shader={uniforms:{},positionShader:["#include <common>","uniform float	delta;","uniform int	loop;","void main() {","vec4 pos = texture2D(texturePosition, gl_FragCoord.xy / resolution.xy);","pos.z += delta;","if (loop == 0 && pos.z >= 150.0) pos.z -= 1350.0;","gl_FragColor = pos;","}"].join("\n"),offlinePositionShader:["#include <common>","uniform float	delta;","uniform int	loop;","void main() {","vec4 pos = texture2D(texturePosition, gl_FragCoord.xy / resolution.xy);","pos.z += delta;","if (loop == 0 && pos.z >= 160.0) pos.z -= 1360.0;","gl_FragColor = pos;","}"].join("\n"),velocityShader:["#include <common>","void main() {","vec2 uv = gl_FragCoord.xy / resolution.xy;","vec4 vel = texture2D(textureVelocity, uv);","gl_FragColor = vel;","}"].join("\n"),vertexShader:["#include <common>","uniform sampler2D texturePosition;","uniform sampler2D textureVelocity;","uniform float	slope;","uniform float	offset;","varying vec2	vUv;","varying float	fade;","varying float	fog;","void main() {","vec4 pos = texture2D(texturePosition, uv);","vec4 vel = texture2D(textureVelocity, uv);","pos.y += (pos.z + 700.0) * slope + offset;","float	z = pos.z + 900.0;","fade = min(1.0, z * 0.005);","fog = min(1.0, 0.5 + z * 0.001);","vUv = vel.zw;","gl_Position = projectionMatrix * modelViewMatrix * pos;","}"].join("\n"),fragmentShader:["uniform sampler2D texture;","varying vec2	vUv;","varying float	fade;","varying float	fog;","void main() {","vec4 color = texture2D(texture, vUv);","if (color.a < 0.8) discard;","color.rgb *= fog;","color.a *= fade;","gl_FragColor = color;","}"].join("\n")
},buil.gpuCompute,buil.positionVariable,buil.velocityVariable,buil.positionUniforms,buil.particleUniforms,buil.particles=144,buil.particlesWidth=Math.ceil(Math.sqrt(buil.particles)),buil.Reset=function(){buil.mesh.visible=!1,buil.mesh2&&(buil.mesh2.visible=!1),buil.positionUniforms.loop.value=0,buil.RestartSimulation(),buil.Draw(!0)},buil.Start=function(){buil.mesh.visible=!0,buil.mesh2&&(buil.mesh2.visible=!0),buil.positionUniforms.loop.value=0},buil.End=function(e){buil.positionUniforms.loop.value=e?1:0},buil.Draw=function(e){buil.positionUniforms.delta.value=drive.speed*app.deltaTime,buil.gpuCompute.compute(),buil.particleUniforms.texturePosition.value=buil.gpuCompute.getCurrentRenderTarget(buil.positionVariable).texture,e&&(buil.particleUniforms.textureVelocity.value=buil.gpuCompute.getCurrentRenderTarget(buil.velocityVariable).texture)},buil.InitComputeRenderer=function(){buil.gpuCompute=new GPUComputationRenderer(buil.particlesWidth,buil.particlesWidth,app.renderer);var e=buil.gpuCompute.createTexture(),i=buil.gpuCompute.createTexture();buil.InitTextures(e,i),buil.velocityVariable=buil.gpuCompute.addVariable("textureVelocity",buil.Shader.velocityShader,i),buil.positionVariable=buil.gpuCompute.addVariable("texturePosition",app.offline?buil.Shader.offlinePositionShader:buil.Shader.positionShader,e),buil.gpuCompute.setVariableDependencies(buil.velocityVariable,[buil.positionVariable,buil.velocityVariable]),buil.gpuCompute.setVariableDependencies(buil.positionVariable,[buil.positionVariable,buil.velocityVariable]),buil.positionUniforms=buil.positionVariable.material.uniforms,buil.velocityUniforms=buil.velocityVariable.material.uniforms,buil.positionUniforms.delta={Value:0},buil.positionUniforms.loop={Value:0};var r=buil.gpuCompute.init();null!==r&&(console.error(r),app.Unsupported())},buil.RestartSimulation=function(){var e=buil.gpuCompute.createTexture(),i=buil.gpuCompute.createTexture();buil.InitTextures(e,i),buil.gpuCompute.renderTexture(e,buil.positionVariable.renderTargets[0]),buil.gpuCompute.renderTexture(e,buil.positionVariable.renderTargets[1]),buil.gpuCompute.renderTexture(i,buil.velocityVariable.renderTargets[0]),buil.gpuCompute.renderTexture(i,buil.velocityVariable.renderTargets[1])},buil.InitPosition=function(){for(var e=new THREE.BufferGeometry,i=new Float32Array(3*buil.particles),r=0,a=0;a<buil.particles;a++)i[r++]=0,i[r++]=0,i[r++]=0;for(var t=new Float32Array(2*buil.particles),d=0,a=0;d<buil.particlesWidth;d++)for(var o=0;o<buil.particlesWidth;o++)t[a++]=o/(buil.particlesWidth-1),t[a++]=d/(buil.particlesWidth-1);e.addAttribute("position",new THREE.BufferAttribute(i,3)),e.addAttribute("uv",new THREE.BufferAttribute(t,2));for(var v=new Uint16Array(6*buil.particles/4),a=0,n=0;a<buil.particles;a+=4)v[n++]=a+0,v[n++]=a+1,v[n++]=a+2,v[n++]=a+0,v[n++]=a+2,v[n++]=a+3;e.setIndex(new THREE.BufferAttribute(v,1)),e.addGroup({start:0,count:v.length}),buil.particleUniforms={texture:{value:app.texture},texturePosition:{value:null},textureVelocity:{value:null},slope:{value:drive.slope},offset:{value:drive.cameraY}};var l=new THREE.ShaderMaterial({uniforms:buil.particleUniforms,blending:THREE.NormalBlending,transparent:!0,vertexShader:buil.Shader.vertexShader,fragmentShader:buil.Shader.fragmentShader});l.extensions.drawBuffers=!0,buil.mesh=new THREE.Mesh(e,l),buil.mesh.position.set(0,0,0),buil.mesh.matrixAutoUpdate=!1,buil.mesh.updateMatrix(),buil.mesh.visible=!1,app.backScene.add(buil.mesh),app.offline&&(buil.mesh2=buil.mesh.clone(),app.frontScene.add(buil.mesh2))},buil.InitTextures=function(e,i){for(var r,a,t,d,o,v,n,l,s,p=e.image.data,u=i.image.data,f=new Float32Array([-.5,-.5,0,.5,-.5,0,.5,.5,0,-.5,.5,0]),c=new Float32Array([0,0,1,0,1,1,0,1]),h=["Buildings-left00011","Buildings-left00014","Buildings-left00013","Buildings-left00003","Buildings-left00001","Buildings-left00004","Buildings-left00009","Buildings-left00012","Buildings-left00006","Buildings-left00002","Buildings-left00010","Buildings-left00011","Buildings-left00005","Buildings-left00008","Buildings-left00015","Buildings-left00007"],m=["Buildings-right00002","Buildings-right00003","Buildings-right00008","Buildings-right00004","Buildings-right00014","Buildings-right00005","Buildings-right00006","Buildings-right00015","Buildings-right00010","Buildings-right00011","Buildings-right00012","Buildings-right00013","Buildings-right00009","Buildings-right00007","Buildings-right00001","Buildings-right00016"],b=0,g=0,S=p.length/16;S>g;g++)if(32>g){var x=app.table[0==(1&g)?h[parseInt(g/2)%h.length]:m[parseInt(g/2)%m.length]];d=x[0],o=x[1],v=x[2],n=x[3],l=x[4],s=x[5],r=-50-650*l,0==(1&g)?(t=1350*g/32-900,t>50&&(t-=1350)):r=-r,a=650*s;for(var M=0;4>M;M++)p[b]=1300*l*f[3*M]+r,p[b+1]=1300*s*f[3*M+1]+a,p[b+2]=t,p[b+3]=1,u[b]=f[3*M]+r,u[b+1]=f[3*M+1]+a,u[b+2]=d+v*c[2*M],u[b+3]=o+n*c[2*M+1],b+=4}else for(var M=0;4>M;M++)p[b]=0,p[b+1]=0,p[b+2]=0,p[b+3]=0,u[b]=0,u[b+1]=0,u[b+2]=0,u[b+3]=0,b+=4},buil.Initialize=function(){buil.InitComputeRenderer(),buil.InitPosition()};var fireworks=fireworks||{};fireworks.Shader={uniforms:{},positionShader:["uniform float	delta;","void main() {","vec2 uv = gl_FragCoord.xy / resolution.xy;","vec4 pos = texture2D(texturePosition, uv);","vec4 vel = texture2D(textureVelocity, uv);","gl_FragColor = pos;","}"].join("\n"),velocityShader:["#include <common>","uniform float	delta;","void main() {","vec2 uv = gl_FragCoord.xy / resolution.xy;","vec4 vel = texture2D(textureVelocity, uv);","vel.w += delta;","gl_FragColor = vel;","}"].join("\n"),vertexShader:["#include <common>","uniform sampler2D texturePosition;","uniform sampler2D textureVelocity;","varying vec4 vColor;","void main() {","vec4 pos;","vec4 vel = texture2D(textureVelocity, uv);","if (vel.w >= 0.0 && vel.w <= 2.0) {","pos = texture2D(texturePosition, uv);","if (pos.z == 0.0) {","vColor = vec4(2.5, 2.5, 1.0, 1.0);","} else {","vColor = vec4(2.5, 1.0, 2.5, 1.0);","}","vColor *= (2.0 - (vel.w + pos.w)) * 0.5;","pos.z = 0.0;","pos.xyz += vel.xyz * (1.0 - pow(1.0 - (vel.w + pos.w * 0.1) * 0.5, 12.0));","pos.y -= 6.666 * pow((vel.w + pos.w), 2.0);","pos.z -= 1000.0;","gl_PointSize = 1.5;","} else {","pos.xyz = vec3(0,0,0);","gl_PointSize = 0.0;","vColor = vec4(0,0,0,0);","}","gl_Position = projectionMatrix * modelViewMatrix * vec4(pos.xyz, 1.0);","}"].join("\n"),fragmentShader:["varying vec4 vColor;","void main() {","if (vColor.a <= 0.0) discard;","if (length(gl_PointCoord - vec2(0.5, 0.5)) > 0.5) discard;","gl_FragColor = vColor;","}"].join("\n")},fireworks.table={CarEmission:[.5,0,.53125,.03125],CarGray:[.53125,0,.5625,.03125],CarWhite:[.5625,0,.59375,.03125],Check:[.59375,0,.625,.03125],Circle:[0,0,.5,.5]},fireworks.gpuCompute,fireworks.positionVariable,fireworks.velocityVariable,fireworks.particleUniforms;var WIDTH=64,PARTICLES=WIDTH*WIDTH;fireworks.Reset=function(){fireworks.particles.visible=!1,fireworks.RestartSimulation(),fireworks.Draw(!0)},fireworks.Start=function(){fireworks.particles.visible=!0},fireworks.Draw=function(e){(fireworks.particles.visible||e)&&(fireworks.positionUniforms.delta.value=app.deltaTime,fireworks.velocityUniforms.delta.value=app.deltaTime,fireworks.gpuCompute.compute(),fireworks.particleUniforms.texturePosition.value=fireworks.gpuCompute.getCurrentRenderTarget(fireworks.positionVariable).texture,fireworks.particleUniforms.textureVelocity.value=fireworks.gpuCompute.getCurrentRenderTarget(fireworks.velocityVariable).texture)},fireworks.InitComputeRenderer=function(){fireworks.gpuCompute=new GPUComputationRenderer(WIDTH,WIDTH,app.renderer);var e=fireworks.gpuCompute.createTexture(),i=fireworks.gpuCompute.createTexture();fireworks.InitTextures(e,i),fireworks.velocityVariable=fireworks.gpuCompute.addVariable("textureVelocity",fireworks.Shader.velocityShader,i),fireworks.positionVariable=fireworks.gpuCompute.addVariable("texturePosition",fireworks.Shader.positionShader,e),fireworks.gpuCompute.setVariableDependencies(fireworks.velocityVariable,[fireworks.positionVariable,fireworks.velocityVariable]),fireworks.gpuCompute.setVariableDependencies(fireworks.positionVariable,[fireworks.positionVariable,fireworks.velocityVariable]),fireworks.positionUniforms=fireworks.positionVariable.material.uniforms,fireworks.velocityUniforms=fireworks.velocityVariable.material.uniforms,fireworks.velocityUniforms.delta={value:0},fireworks.positionUniforms.delta={Value:0};var r=fireworks.gpuCompute.init();null!==r&&(console.error(r),app.Unsupported())},fireworks.RestartSimulation=function(){var e=fireworks.gpuCompute.createTexture(),i=fireworks.gpuCompute.createTexture();fireworks.InitTextures(e,i),fireworks.gpuCompute.renderTexture(e,fireworks.positionVariable.renderTargets[0]),fireworks.gpuCompute.renderTexture(e,fireworks.positionVariable.renderTargets[1]),fireworks.gpuCompute.renderTexture(i,fireworks.velocityVariable.renderTargets[0]),fireworks.gpuCompute.renderTexture(i,fireworks.velocityVariable.renderTargets[1])},fireworks.InitPosition=function(){for(var e=new THREE.BufferGeometry,i=new Float32Array(3*PARTICLES),r=0,a=0;PARTICLES>a;a++)i[r++]=0,i[r++]=0,i[r++]=0;var t=new Float32Array(2*PARTICLES);r=0;for(var d=0;WIDTH>d;d++)for(var a=0;WIDTH>a;a++)t[r++]=a/(WIDTH-1),t[r++]=d/(WIDTH-1);e.addAttribute("position",new THREE.BufferAttribute(i,3)),e.addAttribute("uv",new THREE.BufferAttribute(t,2)),fireworks.particleUniforms={texturePosition:{value:null},textureVelocity:{value:null}};var o=new THREE.ShaderMaterial({uniforms:fireworks.particleUniforms,blending:THREE.AdditiveBlending,transparent:!0,depthWrite:!1,vertexShader:fireworks.Shader.vertexShader,fragmentShader:fireworks.Shader.fragmentShader});o.extensions.drawBuffers=!0,fireworks.particles=new THREE.Points(e,o),fireworks.particles.matrixAutoUpdate=!1,fireworks.particles.updateMatrix(),fireworks.particles.position.set(0,0,1e3),fireworks.particles.visible=!1,app.backScene.add(fireworks.particles)},fireworks.InitTextures=function(e,i){for(var r=e.image.data,a=i.image.data,t=-1,d=0,o=0,v=app.offline?385:500,n=app.offline?110:150,l=0,s=r.length,p=s/4;s>l;l+=4){if(l%p==0){var u=150+60*Math.random(),f=150+200*Math.random(),c=v+n*(2*Math.random()-1);t+=1,d=d+1&1,t>0&&(1==t||2>o&&Math.random()<.75)&&(f=-f,o++)}var h=2*Math.PI*Math.random(),m=u*Math.random();r[l]=f,r[l+1]=c,r[l+2]=d,r[l+3]=1.5*Math.random(),a[l]=Math.cos(h)*m,a[l+1]=Math.sin(h)*m,a[l+2]=u-m,a[l+3]=t*-.666-.666}},fireworks.Initialize=function(){fireworks.InitComputeRenderer(),fireworks.InitPosition()};